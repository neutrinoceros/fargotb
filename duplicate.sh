#!/bin/bash

# --------------------------
# Author : Cl√©ment Robert
# written october 2016
# --------------------------
# This program copies a base simulation with all its file-tree 
# except the output files


# PARSING
#----------------------------------------------------------------------

base=$(readlink -e $1)    # gets the absolute path 
                          # even from relative input
target=$(basename $2)     # removes a "/" ending char if provided


# SYNCHRONIZATION
#----------------------------------------------------------------------

FLAGS=(
    --exclude="*output/*"  # output files
    --exclude="*.std*"     # .stdout and .stderr generated by mpi
    --exclude="*~"         # temp files
    --exclude="\#*\#"      # emacs autosave files
    )

rsync -av "${FLAGS[@]}" $base/ $target



# AUTO-EDITION of files mentioning their own location
#----------------------------------------------------------------------
# /!\ This part may still be subject to bug corrections

sed -i "s!$base!$target!g" $target/jobs/*oar
sed -i "s!$base!$target!g" $target/input*/*par


# SECURITY
#----------------------------------------------------------------------
# we force the user to change persmissions before they can 
# run the simulation in case there is still something wrong

chmod -x $target/*exe 